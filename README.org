* The Biosynthetic Gene cluster Meta'omics abundance Profiler (BiG-MAP)
#+CAPTION: The pipelene of all the modules combined
#+NAME: metAbEx Pipeline 
[[https://github.com/KoenvdBerg/BiG-MAP/FINAL_pipeline_V3.png]]

The Biosynthetic Gene cluster Meta'omics abundance Profiler (BiG-MAP)
is currently in development. For the analysis of bacterial metagenomic
and metatranscriptomic samples more and more tools become
available. This tool is focussed on finding the representation of
primary metabolic pathways and their related homologs in metagenomic
and metatranscriptomic samples. These pathways are readily obtained
from (draft) bacterial genomes using antiSMASH or gutSMASH. To be able
to process the outputs from these tools into proper abundance and
expressions values, the following programs form the essential part of
BiG-MAP:
- BiG-MAP.download.py
- BiG-MAP.family.py
- BiG-MAP.map.py
- BiG-MAP.analyse.py
For information on how to implement this program, scroll down to
*Overview and quickstart*. 

* Installation
Install BiG-MAP dependencies using conda. Conda can be installed from
[[https://docs.conda.io/en/latest/miniconda.html][miniconda_link]]. 
#+BEGIN_EXAMPLE
~$ conda env create -f BiG-MAP.yml BiG-MAP
~$ conda activate BiG-MAP
#+END_EXAMPLE
After this all the dependencies are installed. To install BiG-MAP run:
#+BEGIN_EXAMPLE
~$ git clone https://github.com/KoenvdBerg/BiG-MAP.git
#+END_EXAMPLE


* Example Workflow
A typical workflow for BiG-MAP consists of the following 4 consecutive steps:
1) Downloading WGS data using BiG-MAP.download.py
2) Generating gene cluster families (GCFs) and housekeeping gene
   families (HGFs) using BiG-MAP.family.py
3) Computing abundance and expression profiles of selected
   representatives from each GCF and HGF using BiG-MAP.map.py
4) Analysing the resulting BIOM file for profiles using
   BiG-MAP.analyse.py
The four steps are described below, and for each an example is
provided. 

** 1. S-MAP.download.py
This script is created to easily download the metagenomic and/or
metatranscriptomic samples from the online NCBI repository. First, the
samples are downloaded in /.SRA/ format, and then they are converted
into /.fastq/ pairs using /fastq-dump/. 
#+BEGIN_EXAMPLE
python3 BiG-MAP.download.py [Options]* -A [accession_list_file] -O [path_to_outdir]
#+END_EXAMPLE
To download the 78 samples from Schirmer et al. (2018), go to the [[https://www.ncbi.nlm.nih.gov/Traces/study/][SRA
run selector]] and run the following command:
#+BEGIN_EXAMPLE
python3 BiG-MAP.download.py -A Acc_list.txt -O /mnt/scratch/usr001/fastq/schirmer/

Acc_list.txt:
SRR5983273
SRR5983265
SRR5983266
SRR5983268
SRR5983270
SRR5983271
SRR5983275
...
#+END_EXAMPLE
| nr | Source                                     | Explanation                                                                                                                                                             | Environment             | Accesssion   |
|----+--------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------+--------------|
|  0 | Choose your own data                       |                                                                                                                                                                         |                         |              |
|  1 | Schirmer et al.                            | contains 78 high-quality paired metagenomes and metatranscriptomes                                                                                                      | Gut microbiome          | PRJNA389280  |
|  2 | Franzosa et al.                            | 8 samples (in triplicate) of metagenomic and metatranscriptomic data                                                                                                    | Gut and oral microbiome | PRJNA188481  |
|  3 | Greenblum, Turnbaugh & Borenstein36        | Illumina-derived shotgun metagenomic data from 124 unrelated Danish and Spanish persons labelled with BMI and IBD data                                                  | Gut microbiome          | ERA000116    |
|  4 | Abu-Ali et al.                             | It reports a large-scale investigation of 372 human faecal metatranscriptomes and 929 metagenomes from a subset of 308 men in the Health Professionals Follow-Up Study. | Gut microbiome          | PRJNA354235  |
|  5 | University Medical Centre Groningen (UMCG) | Metagenomic data of 45 IBD and 20 non-IBD Dutch participants. Could be useful for validation of our results.                                                            | Gut microbiome          | upon request |

** S-MAP.genecluster.py
For obtaining the correct metabolic gene cluster sequences, either
antiSMASH or gutSMASH should be run in advance on interesting
reference genomes. This module will consequently take those results
and convert them into a redundancy filtered reference fasta
file. fastANI is used to find gene clusters that are too similar in
function, and these are then filtered out based on a similarity
cut-off of 0.9. The similarity is calculated for the protein sequences
only, since these sequences are more relevant for the end-function of
the gene cluster and are expected to be more similar. In addition,
housekeeping genes are included to be able to compare the results to
expression and abundance levels that are known /a priori/. A typical
workflow looks like this:
#+BEGIN_EXAMPLE
______________________________________________________________________

  S-MAP genecluster: creates a redundancy filtered reference fna
______________________________________________________________________

Generic command: python3 S-MAP.genecluster.py [Options]*
-D [input dir(s)] -O [output dir]

Create a redundancy filtered fasta reference file from multiple
anti/gutSMASH outputs.

Obligatory arguments:
    -D   Specify the path to the directory containing the gut- or
         antiSMASH outputs here. This could be a singular directory,
         or a space seperated list of directories.
    -O   Put path to the folder where the fastANI filtered gene cluster
         files should be located here. The folder should be an
         existing folder. Default = current folder (.)

Options:
    -t   Fraction between 0 and 1; the similarity treshold that
         determines when the protein sequences of the gene clusters
         can be considered similar (>0.80 is assumed to have the same
         function). Default = 0.9.
    -f   Specify here the number of genes that are flanking the core
         genes of the gene cluster. 0 --> only the core, n --> n
         genes included that flank the core. defualt = 0
______________________________________________________________________
#+END_EXAMPLE
** S-MAP.map.py
This module is designed to map the metagenomic and/or
metatranscriptomic samples to the reference that is created using
module 2. It does this using /bowtie2/. The following will be
computed: TPM, RPKM, coverage, core coverage. The coverage is
calculated using /Bedtools/, and the read count values using
/Samtools/. The following options are included:

#+BEGIN_EXAMPLE
______________________________________________________________________

     S-MAP map: maps the paired reads to the predicted MGCs
______________________________________________________________________

Generic command: python3 S-MAP.map.py [Options]* -R [reference]
-I1 [mate-1s] -I2 [mate-2s] -O [outdir]

Maps the metagenomic/metatranscriptomic reads to the fasta reference
file and outputs RPKM read counts in .csv and BIOM format

Obligatory arguments:
    -R    Provide the reference fasta file in .fasta or .fna format
    -I1   Provide the mate 1s of the paired metagenomic and/or
          metatranscriptomic samples here. These samples should be
          provided in fastq-format (.fastq, .fq, .fq.gz). Also, this
          can be a space seperated list from the command line.
    -I2   Provide the mate 2s of the paired metagenomic and/or
          metatranscriptomic samples here. These samples should be
          provided in fastq-format (.fastq, .fq, .fq.gz). Also, this
          can be a space seperated list from the command line.
    -O    Put path to the output folder where the results should be
          deposited. Default = current folder (.)

Options:
    -cc   Also calculate the RPKM and coverage values for the core of
          the cluster present in the bedfile. Specify the bedfile
          here. Bedfiles are outputted by S-MAP.genecluster.py
          automatically
    -b    Outputs the resulting read counts in biom format (v1.0) as
          well. This will be useful to analyze the results in
          S-MAP.analyse. Therefore, it  is important to include
          the metadata here as well: this metagenomical data should
          be in the same format as the example metadata
    -f    Input files are in fasta format (.fna, .fa, .fasta): True/False.
          Default = False.
    -s    Bowtie2 setting: very-fast-local, fast-local, sensitive-local
          , very-sensitive-local. Default = sensitive-local
______________________________________________________________________
#+END_EXAMPLE
** S-MAP.analyse.py
This program analyses the mapping results using either a zero-inflated
Gaussian mixture model (fitZIG) or a Kruskall model. 

#+BEGIN_EXAMPLE
______________________________________________________________________

S-MAP analyse: analyse the biom-outputs (ZIG/Kruskall-Wallis)
______________________________________________________________________

Generic command: python3 S-MAP.analyse.py test -B [biom_file]
-T [SampleType] -M [meta_group] -G [[groups]] -O [outdir]

Tests the present biom file using either a fitZIG model or a
Kruskall-Wallis model. Note that it is also possible to work in R
studio with the R script: meteclust.norm.R

Obligatory arguments:
    -B    Provide the Biom file here
    -T    metagenomic/metatranscriptomic
    -M    provide the metagroup here. This is the first column in the
          options output. Examples: DiseaseStatus, Longitude, etc...
    -G    Space separated list of 2 groups that are to be compared.
          Example: UC and non-IBD --> UC non-IBD
    -O    Put path to the output folder where the results should be
          deposited. Default = current folder (.)
______________________________________________________________________
#+END_EXAMPLE
* Requirements
** Software:
- Python 3+
- R statistics
- fastq-dump
- fastANI
- HMMer
- Bowtie2
- Samtools
- Bedtools
- biom

** Packages:
*** Python
- BioPython
- pandas
*** R
- metagenomeSeq
- biomformat
- ComplexHeatmap=2.0.0
- viridisLite
- RColorBrewer
- tidyverse
